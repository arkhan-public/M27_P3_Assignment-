@page
@model DetailsModel
@{
    ViewData["Title"] = Model.Question?.Title ?? "Question Details";
}

@if (Model.Question == null)
{
    <div class="alert alert-danger">Question not found.</div>
}
else
{
    <div class="row">
        <div class="col-md-12">
            <div class="card question-card mb-4">
                <div class="card-body">
                    <h2 class="mb-3">@Model.Question.Title</h2>

                    <div class="row">
                        <div class="col-md-1 text-center vote-buttons">
                            <button class="btn btn-link" onclick="vote(@Model.Question.Id, null, 1)">▲</button>
                            <strong id="question-votes">@Model.Question.VoteCount</strong>
                            <button class="btn btn-link" onclick="vote(@Model.Question.Id, null, -1)">▼</button>
                        </div>
                        <div class="col-md-11">
                            <p style="white-space: pre-wrap;">@Model.Question.Body</p>

                            <div class="mb-3">
                                @foreach (var tag in Model.Question.Tags)
                                {
                                    <a href="/Questions?tag=@tag.Name" class="tag text-decoration-none me-1">@tag.Name</a>
                                }
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    @if (Model.Question.UpdatedAt.HasValue)
                                    {
                                        <small class="text-muted">Edited @Model.Question.UpdatedAt.Value.ToString("MMM dd, yyyy")</small>
                                    }
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">
                                        Asked @Model.Question.CreatedAt.ToString("MMM dd, yyyy") by <strong>@Model.Question.User.Username</strong>
                                    </small>
                                </div>
                            </div>

                            <div class="mt-3">
                                <h6>Comments</h6>
                                <div id="question-comments">
                                    @foreach (var comment in Model.Question.Comments)
                                    {
                                        <div class="border-bottom py-2">
                                            <small>@comment.Body - <strong>@comment.User.Username</strong> (@comment.CreatedAt.ToString("MMM dd"))</small>
                                        </div>
                                    }
                                </div>
                                <div class="mt-2" id="question-comment-form" style="display:none;">
                                    <input type="text" class="form-control form-control-sm" id="question-comment-text" placeholder="Add a comment..." maxlength="500">
                                    <button class="btn btn-sm btn-primary mt-1" onclick="addComment(@Model.Question.Id, null)">Add Comment</button>
                                </div>
                                <button class="btn btn-link btn-sm p-0 mt-1" id="show-question-comment-btn" onclick="showCommentForm('question')">Add a comment</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h4>@Model.Question.Answers.Count Answer(s)</h4>

            @foreach (var answer in Model.Question.Answers)
            {
                <div class="card answer-card @(answer.IsAccepted ? "accepted-answer" : "") mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-1 text-center vote-buttons">
                                <button class="btn btn-link" onclick="vote(null, @answer.Id, 1)">▲</button>
                                <strong id="answer-@answer.Id-votes">@answer.VoteCount</strong>
                                <button class="btn btn-link" onclick="vote(null, @answer.Id, -1)">▼</button>
                                @if (answer.IsAccepted)
                                {
                                    <div class="text-success mt-2">✓</div>
                                }
                            </div>
                            <div class="col-md-11">
                                <p style="white-space: pre-wrap;">@answer.Body</p>

                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        @if (answer.UpdatedAt.HasValue)
                                        {
                                            <small class="text-muted">Edited @answer.UpdatedAt.Value.ToString("MMM dd, yyyy")</small>
                                        }
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">
                                            Answered @answer.CreatedAt.ToString("MMM dd, yyyy") by <strong>@answer.User.Username</strong>
                                        </small>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <h6>Comments</h6>
                                    <div id="answer-@answer.Id-comments">
                                        @foreach (var comment in answer.Comments)
                                        {
                                            <div class="border-bottom py-2">
                                                <small>@comment.Body - <strong>@comment.User.Username</strong> (@comment.CreatedAt.ToString("MMM dd"))</small>
                                            </div>
                                        }
                                    </div>
                                    <div class="mt-2" id="answer-@answer.Id-comment-form" style="display:none;">
                                        <input type="text" class="form-control form-control-sm" id="answer-@answer.Id-comment-text" placeholder="Add a comment..." maxlength="500">
                                        <button class="btn btn-sm btn-primary mt-1" onclick="addComment(null, @answer.Id)">Add Comment</button>
                                    </div>
                                    <button class="btn btn-link btn-sm p-0 mt-1" onclick="showCommentForm('answer', @answer.Id)">Add a comment</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <div class="card mt-4" id="answerForm" style="display:none;">
                <div class="card-header">
                    <h5 class="mb-0">Your Answer</h5>
                </div>
                <div class="card-body">
                    <div id="answerError" class="alert alert-danger d-none"></div>
                    <textarea class="form-control mb-3" id="answerBody" rows="8" placeholder="Write your answer here..." minlength="20" maxlength="5000"></textarea>
                    <button class="btn btn-primary" onclick="submitAnswer()">Post Answer</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        if (getToken()) {
            document.getElementById('answerForm').style.display = 'block';
            document.getElementById('show-question-comment-btn').style.display = 'inline-block';
        }

        function showCommentForm(type, id) {
            if (!getToken()) {
                window.location.href = '/Login';
                return;
            }

            if (type === 'question') {
                document.getElementById('question-comment-form').style.display = 'block';
                document.getElementById('show-question-comment-btn').style.display = 'none';
            } else {
                document.getElementById('answer-' + id + '-comment-form').style.display = 'block';
            }
        }

        async function vote(questionId, answerId, voteType) {
            if (!getToken()) {
                window.location.href = '/Login';
                return;
            }

            try {
                const response = await fetch('/api/vote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify({
                        questionId,
                        answerId,
                        type: voteType
                    })
                });

                if (response.ok) {
                    location.reload();
                } else if (response.status === 401) {
                    window.location.href = '/Login';
                }
            } catch (error) {
                console.error('Error voting:', error);
            }
        }

        async function submitAnswer() {
            if (!getToken()) {
                window.location.href = '/Login';
                return;
            }

            const body = document.getElementById('answerBody').value;
            const questionId = @(Model.Question?.Id ?? 0);

            if (body.length < 20) {
                document.getElementById('answerError').textContent = 'Answer must be at least 20 characters';
                document.getElementById('answerError').classList.remove('d-none');
                return;
            }

            try {
                const response = await fetch('/api/answers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify({ body, questionId })
                });

                if (response.ok) {
                    location.reload();
                } else if (response.status === 401) {
                    window.location.href = '/Login';
                } else {
                    const data = await response.json();
                    document.getElementById('answerError').textContent = data.message || 'Failed to post answer';
                    document.getElementById('answerError').classList.remove('d-none');
                }
            } catch (error) {
                document.getElementById('answerError').textContent = 'An error occurred. Please try again.';
                document.getElementById('answerError').classList.remove('d-none');
            }
        }

        async function addComment(questionId, answerId) {
            if (!getToken()) {
                window.location.href = '/Login';
                return;
            }

            let body;
            if (questionId) {
                body = document.getElementById('question-comment-text').value;
            } else {
                body = document.getElementById('answer-' + answerId + '-comment-text').value;
            }

            if (body.length < 5) {
                alert('Comment must be at least 5 characters');
                return;
            }

            try {
                const response = await fetch('/api/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify({ body, questionId, answerId })
                });

                if (response.ok) {
                    location.reload();
                } else if (response.status === 401) {
                    window.location.href = '/Login';
                }
            } catch (error) {
                console.error('Error posting comment:', error);
            }
        }
    </script>
}
