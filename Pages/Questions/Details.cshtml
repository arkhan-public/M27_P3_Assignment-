@page
@model DetailsModel
@{
    ViewData["Title"] = Model.Question?.Title ?? "Question Details";
}

@if (Model.Question == null)
{
    <div class="alert alert-danger">Question not found.</div>
}
else
{
    <div class="row">
        <div class="col-md-12">
            <div class="card question-card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h2 class="mb-3">@Model.Question.Title</h2>
                        <div>
                            <a id="editQuestionBtn" class="btn btn-sm btn-outline-primary me-2" href="/Questions/Edit?id=@Model.Question.Id" style="display:none;">Edit</a>
                            <button id="deleteQuestionBtn" class="btn btn-sm btn-outline-danger" style="display:none;">Delete</button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-1 text-center vote-buttons">
                            <button class="btn btn-link" onclick="vote(@Model.Question.Id, null, 1)">▲</button>
                            <strong id="question-votes">@Model.Question.VoteCount</strong>
                            <button class="btn btn-link" onclick="vote(@Model.Question.Id, null, -1)">▼</button>
                        </div>
                        <div class="col-md-11">
                            <p style="white-space: pre-wrap;">@Model.Question.Body</p>

                            <div class="mb-3">
                                @foreach (var tag in Model.Question.Tags)
                                {
                                    <a href="/Questions?tag=@tag.Name" class="tag text-decoration-none me-1">@tag.Name</a>
                                }
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    @if (Model.Question.UpdatedAt.HasValue)
                                    {
                                        <small class="text-muted">Edited @Model.Question.UpdatedAt.Value.ToString("MMM dd, yyyy")</small>
                                    }
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">
                                        Asked @Model.Question.CreatedAt.ToString("MMM dd, yyyy") by <strong>@Model.Question.User.Username</strong>
                                    </small>
                                </div>
                            </div>

                            <div class="mt-3">
                                <h6>Comments</h6>
                                <div id="question-comments">
                                    @foreach (var comment in Model.Question.Comments)
                                    {
                                        <div class="border-bottom py-2 d-flex justify-content-between align-items-start" data-comment-id="@comment.Id">
                                            <div>
                                                <small>@comment.Body - <strong>@comment.User.Username</strong> (@comment.CreatedAt.ToString("MMM dd"))</small>
                                            </div>
                                            <div>
                                                <button class="btn btn-link btn-sm p-0 me-2" id="editComment-@comment.Id" data-owner="@comment.UserId" style="display:none;" onclick="editComment(@comment.Id)">Edit</button>
                                                <button class="btn btn-link btn-sm text-danger p-0" id="deleteComment-@comment.Id" data-owner="@comment.UserId" style="display:none;" onclick="deleteComment(@comment.Id)">Delete</button>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="mt-2" id="question-comment-form" style="display:none;">
                                    <input type="text" class="form-control form-control-sm" id="question-comment-text" placeholder="Add a comment..." maxlength="500">
                                    <button class="btn btn-sm btn-primary mt-1" onclick="addComment(@Model.Question.Id, null)">Post Comment</button>
                                </div>
                                <button class="btn btn-link btn-sm p-0 mt-1" id="show-question-comment-btn" onclick="showCommentForm('question')">Add a comment</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h4>@Model.Question.Answers.Count Answer(s)</h4>

            @foreach (var answer in Model.Question.Answers)
            {
                <div class="card answer-card @(answer.IsAccepted ? "accepted-answer" : "") mb-3" data-answer-id="@answer.Id">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-1 text-center vote-buttons">
                                <button class="btn btn-link" onclick="vote(null, @answer.Id, 1)">▲</button>
                                <strong id="answer-@answer.Id-votes">@answer.VoteCount</strong>
                                <button class="btn btn-link" onclick="vote(null, @answer.Id, -1)">▼</button>
                                @if (answer.IsAccepted)
                                {
                                    <div class="text-success mt-2">✓</div>
                                }
                            </div>

                            <div class="col-md-11">
                                @* Controls: accept (for question owner) and edit/delete (for answer owner) *@
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        @if (answer.UpdatedAt.HasValue)
                                        {
                                            <small class="text-muted">Edited @answer.UpdatedAt.Value.ToString("MMM dd, yyyy")</small>
                                        }
                                    </div>

                                    <div class="d-flex align-items-center">
                                        @* Accept button (shown to question owner via JS) *@
                                        @if (!answer.IsAccepted)
                                        {
                                            <button id="accept-@answer.Id" class="btn btn-sm btn-success me-2" style="display:none;" onclick="acceptAnswer(@answer.Id)">Accept</button>
                                        }

                                        @* Edit/Delete for answer owner. add data-owner attribute for robust client check *@
                                        <a id="editAnswer-@answer.Id" data-owner="@answer.UserId" class="btn btn-sm btn-outline-primary me-2" href="/Answers/Edit?id=@answer.Id" style="display:none;">Edit</a>
                                        <button id="deleteAnswer-@answer.Id" data-owner="@answer.UserId" class="btn btn-sm btn-outline-danger" style="display:none;">Delete</button>
                                    </div>
                                </div>

                                <p style="white-space: pre-wrap;">@answer.Body</p>

                                <div class="d-flex justify-content-end">
                                    <small class="text-muted">
                                        Answered @answer.CreatedAt.ToString("MMM dd, yyyy") by <strong>@answer.User.Username</strong>
                                    </small>
                                </div>

                                <div class="mt-3">
                                    <h6>Comments</h6>
                                    <div id="answer-@answer.Id-comments">
                                        @foreach (var comment in answer.Comments)
                                        {
                                            <div class="border-bottom py-2 d-flex justify-content-between align-items-start" data-comment-id="@comment.Id">
                                                <div>
                                                    <small>@comment.Body - <strong>@comment.User.Username</strong> (@comment.CreatedAt.ToString("MMM dd"))</small>
                                                </div>
                                                <div>
                                                    <button class="btn btn-link btn-sm p-0 me-2" id="editComment-@comment.Id" data-owner="@comment.UserId" style="display:none;" onclick="editComment(@comment.Id)">Edit</button>
                                                    <button class="btn btn-link btn-sm text-danger p-0" id="deleteComment-@comment.Id" data-owner="@comment.UserId" style="display:none;" onclick="deleteComment(@comment.Id)">Delete</button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                    <div class="mt-2" id="answer-@answer.Id-comment-form" style="display:none;">
                                        <input type="text" class="form-control form-control-sm" id="answer-@answer.Id-comment-text" placeholder="Add a comment..." maxlength="500">
                                        <button class="btn btn-sm btn-primary mt-1" onclick="addComment(null, @answer.Id)">Post Comment</button>
                                    </div>
                                    <button class="btn btn-link btn-sm p-0 mt-1" onclick="showCommentForm('answer', @answer.Id)">Add a comment</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <div class="card mt-4" id="answerForm" style="display:none;">
                <div class="card-header">
                    <h5 class="mb-0">Your Answer</h5>
                </div>
                <div class="card-body">
                    <div id="answerError" class="alert alert-danger d-none"></div>
                    <textarea class="form-control mb-3" id="answerBody" rows="8" placeholder="Write your answer here..." minlength="20" maxlength="5000"></textarea>
                    <button class="btn btn-primary" onclick="submitAnswer()">Post Answer</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Pass server-side data to JavaScript
        window.questionDetailsData = {
            questionOwnerId: @(Model.Question?.UserId ?? 0),
            questionId: @(Model.Question?.Id ?? 0)
        };
    </script>
    <script src="~/js/question-details.js"></script>
}